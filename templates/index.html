<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Folder</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .video-container {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: flex-start;
        }
        .video-item {
            width: 30%;
            height: auto;
            object-fit: cover;
        }
        .result {
            margin-top: 20px;
            font-weight: bold;
            white-space: pre-wrap;
        }
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 18px;
            text-align: center;
        }
        #loadingOverlay img {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Upload a Folder</h1>
    <form id="uploadForm">
        <input id="folderInput" type="file" name="files" webkitdirectory directory multiple>
        <button type="submit">Upload and Process</button>
    </form>

    <div id="videoContainer">
        <h2>影片預覽</h2>
        <p>尚未選擇任何檔案。</p>
    </div>

    <div id="processedVideoContainer" class="video-container">
        <h2>處理後的影片</h2>
    </div>

    <div id="loadingOverlay">
        <div>
            <p>處理中，請稍候...</p>
            <img src="https://i.gifer.com/4V0b.gif" alt="Loading" width="50">
        </div>
    </div>

    <script>
        const folderInput = document.getElementById('folderInput');
        const videoContainer = document.getElementById('videoContainer');
        const processedVideoContainer = document.getElementById('processedVideoContainer');
        const uploadForm = document.getElementById('uploadForm');
        const loadingOverlay = document.getElementById('loadingOverlay');

        folderInput.addEventListener('change', (event) => {
            const videoFiles = Array.from(event.target.files).filter(file =>
                file.type.startsWith('video/')
            );

            videoContainer.innerHTML = '<h2>影片預覽</h2>';
            if (videoFiles.length === 0) {
                videoContainer.innerHTML += '<p>未找到任何影片檔案。</p>';
            } else {
                videoFiles.forEach(file => {
                    const videoElement = document.createElement('video');
                    videoElement.src = URL.createObjectURL(file);
                    videoElement.controls = true;
                    videoElement.className = 'video-item';
                    videoContainer.appendChild(videoElement);
                });
            }
        });

        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // 阻止表單提交後重新加載頁面

            // 顯示處理中的提示和背景遮罩
            loadingOverlay.style.display = 'flex';

            const formData = new FormData();
            Array.from(folderInput.files).forEach(file => formData.append('files', file));

            try {
                // 提交表單並等待伺服器處理
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const videoUrl = await response.text(); // 伺服器返回影片路徑
                    const videoElement = document.createElement('video');
                    videoElement.src = videoUrl;
                    videoElement.controls = true;
                    videoElement.className = 'video-item';
                    processedVideoContainer.appendChild(videoElement);
                } else {
                    alert('Error during processing.');
                }
            } catch (error) {
                alert('An unexpected error occurred.');
            } finally {
                // 隱藏處理中的提示和背景遮罩
                loadingOverlay.style.display = 'none';
            }
        });
    </script>
</body>
</html>
